<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home Security - Attack Detection System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(to bottom right, #f8fafc, #e2e8f0);
            min-height: 100vh;
            color: #1f2937;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .header-icon {
            background: #2563eb;
            padding: 0.5rem;
            border-radius: 0.5rem;
        }

        .header-icon svg {
            width: 2rem;
            height: 2rem;
            color: white;
        }

        h1 {
            font-size: 2rem;
            font-weight: bold;
            color: #111827;
        }

        .subtitle {
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: box-shadow 0.2s;
        }

        .stat-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .stat-header {
            display: flex;
            align-items: start;
            justify-content: space-between;
        }

        .stat-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #111827;
            margin-bottom: 0.5rem;
        }

        .stat-icon {
            padding: 0.75rem;
            border-radius: 0.5rem;
            opacity: 0.1;
        }

        .stat-icon svg {
            width: 1.5rem;
            height: 1.5rem;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn svg {
            width: 1.25rem;
            height: 1.25rem;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-success {
            background: #16a34a;
            color: white;
        }

        .btn-success:hover {
            background: #15803d;
        }

        .btn-secondary {
            background: #4b5563;
            color: white;
        }

        .btn-secondary:hover {
            background: #374151;
        }

        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
        }

        @media (max-width: 1100px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        .section {
            min-width: 0;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .device-card, .event-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .device-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .device-info h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .device-type {
            font-size: 0.875rem;
            color: #6b7280;
            text-transform: capitalize;
        }

        .device-icon svg {
            width: 1.5rem;
            height: 1.5rem;
        }

        .device-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .device-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
        }

        .detail-label {
            color: #6b7280;
        }

        .detail-value {
            font-family: monospace;
            color: #374151;
        }

        .status-online {
            color: #16a34a;
            border-color: #86efac;
            background: #f0fdf4;
        }

        .status-offline {
            color: #6b7280;
            border-color: #e5e7eb;
            background: #f9fafb;
        }

        .status-compromised {
            color: #dc2626;
            border-color: #fca5a5;
            background: #fef2f2;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-critical {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-high {
            background: #fed7aa;
            color: #9a3412;
        }

        .badge-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-low {
            background: #dbeafe;
            color: #1e40af;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }

        .event-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .event-description {
            font-size: 0.875rem;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .event-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: #6b7280;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            padding: 1rem;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 32rem;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 0.25rem;
        }

        .close-btn:hover {
            color: #6b7280;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #2563eb;
            ring: 2px;
            ring-color: #2563eb;
        }

        .form-actions {
            display: flex;
            gap: 0.75rem;
            padding-top: 1rem;
        }

        .btn-block {
            flex: 1;
        }

        .btn-outline {
            background: white;
            border: 1px solid #d1d5db;
            color: #374151;
        }

        .btn-outline:hover {
            background: #f9fafb;
        }

        .empty-state {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 3rem 2rem;
            text-align: center;
        }

        .empty-state svg {
            width: 3rem;
            height: 3rem;
            margin: 0 auto 0.75rem;
            color: #d1d5db;
        }

        .empty-state p {
            color: #6b7280;
            margin-bottom: 1rem;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .loading svg {
            width: 4rem;
            height: 4rem;
            color: #2563eb;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .filter-panel {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .filter-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
        }

        .resolved-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            color: #16a34a;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .resolve-btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .resolve-btn:hover {
            background: #f9fafb;
        }

        .patterns-panel {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .pattern-item {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
        }

        .pattern-item:hover {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .pattern-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            gap: 0.75rem;
        }

        .pattern-title {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .pattern-description {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
        }

        .toggle-btn svg {
            width: 2rem;
            height: 2rem;
            transition: color 0.2s;
        }

        .toggle-active {
            color: #16a34a;
        }

        .toggle-inactive {
            color: #9ca3af;
        }

        .pattern-status {
            font-size: 0.75rem;
            font-weight: 500;
            padding-top: 0.5rem;
            border-top: 1px solid #f3f4f6;
            margin-top: 0.5rem;
        }

        .status-active {
            color: #16a34a;
        }

        .status-inactive {
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://mhygvwjbmgqfljjvvald.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oeWd2d2pibWdxZmxqanZ2YWxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMDIxOTMsImV4cCI6MjA3Njg3ODE5M30.CP40Ulr6JPdCBJGazGQQR70evYUosjwH6wL5TA2paz8';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let state = {
            devices: [],
            events: [],
            patterns: [],
            loading: true,
            showAddModal: false,
            showSimulateModal: false,
            showExportModal: false,
            showPatternsPanel: false,
            severityFilter: 'all',
            eventTypeFilter: 'all',
            showResolved: false
        };

        const icons = {
            shield: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>',
            plus: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>',
            activity: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>',
            alert: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
            check: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
            zap: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>',
            wifi: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"/></svg>',
            wifiOff: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414"/></svg>',
            x: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>',
            download: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>',
            settings: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>',
            filter: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>',
            toggleLeft: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6"/><circle cx="8" cy="12" r="3" stroke-width="2"/></svg>',
            toggleRight: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6"/><circle cx="16" cy="12" r="3" stroke-width="2"/></svg>'
        };

        async function fetchDevices() {
            const { data, error } = await supabase
                .from('devices')
                .select('*')
                .order('created_at', { ascending: false });

            if (!error && data) {
                state.devices = data;
            }
            state.loading = false;
            render();
        }

        async function fetchEvents() {
            const { data, error } = await supabase
                .from('security_events')
                .select('*, devices(name, device_type)')
                .order('detected_at', { ascending: false })
                .limit(50);

            if (!error && data) {
                state.events = data;
            }
            render();
        }

        async function fetchPatterns() {
            const { data, error } = await supabase
                .from('attack_patterns')
                .select('*')
                .order('severity', { ascending: false });

            if (!error && data) {
                state.patterns = data;
            }
            render();
        }

        async function addDevice(formData) {
            const { error } = await supabase
                .from('devices')
                .insert([{ ...formData, status: 'online' }]);

            if (!error) {
                fetchDevices();
            }
        }

        async function simulateAttack(deviceId, metrics) {
            const apiUrl = `${SUPABASE_URL}/functions/v1/detect-attacks`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    },
                    body: JSON.stringify({
                        device_id: deviceId,
                        ...metrics,
                    }),
                });

                if (response.ok) {
                    fetchEvents();
                    fetchDevices();
                }
            } catch (error) {
                console.error('Error simulating attack:', error);
            }
        }

        async function resolveEvent(eventId) {
            const { error } = await supabase
                .from('security_events')
                .update({ resolved: true, resolved_at: new Date().toISOString() })
                .eq('id', eventId);

            if (!error) {
                fetchEvents();
            }
        }

        async function togglePattern(id, currentState) {
            const { error } = await supabase
                .from('attack_patterns')
                .update({ active: !currentState })
                .eq('id', id);

            if (!error) {
                fetchPatterns();
            }
        }

        function getFilteredEvents() {
            return state.events.filter(event => {
                if (state.severityFilter !== 'all' && event.severity !== state.severityFilter) return false;
                if (state.eventTypeFilter !== 'all' && event.event_type !== state.eventTypeFilter) return false;
                if (!state.showResolved && event.resolved) return false;
                return true;
            });
        }

        function getStats() {
            return {
                totalDevices: state.devices.length,
                onlineDevices: state.devices.filter(d => d.status === 'online').length,
                compromisedDevices: state.devices.filter(d => d.status === 'compromised').length,
                activeAlerts: state.events.filter(e => !e.resolved).length
            };
        }

        function render() {
            const app = document.getElementById('app');

            if (state.loading) {
                app.innerHTML = `
                    <div class="loading">
                        <div class="loading-icon">${icons.shield}</div>
                        <p style="color: #6b7280; margin-top: 1rem;">Loading security dashboard...</p>
                    </div>
                `;
                return;
            }

            const stats = getStats();
            const filteredEvents = getFilteredEvents();

            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="header-icon">${icons.shield}</div>
                        <div>
                            <h1>Smart Home Security</h1>
                            <p class="subtitle">Real-time attack detection and monitoring</p>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-title">Total Devices</div>
                                    <div class="stat-value">${stats.totalDevices}</div>
                                </div>
                                <div class="stat-icon" style="background: #2563eb;">${icons.activity}</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-title">Online Devices</div>
                                    <div class="stat-value">${stats.onlineDevices}</div>
                                </div>
                                <div class="stat-icon" style="background: #16a34a;">${icons.check}</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-title">Compromised</div>
                                    <div class="stat-value">${stats.compromisedDevices}</div>
                                </div>
                                <div class="stat-icon" style="background: #dc2626;">${icons.alert}</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-title">Active Alerts</div>
                                    <div class="stat-value">${stats.activeAlerts}</div>
                                </div>
                                <div class="stat-icon" style="background: #f97316;">${icons.shield}</div>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-primary" onclick="openAddModal()">${icons.plus} Add Device</button>
                        <button class="btn btn-danger" onclick="openSimulateModal()">${icons.zap} Simulate Attack</button>
                        <button class="btn btn-success" onclick="exportReport()">${icons.download} Export Report</button>
                        <button class="btn btn-secondary" onclick="togglePatternsPanel()">${icons.settings} Attack Patterns</button>
                    </div>

                    ${state.showPatternsPanel ? renderPatternsPanel() : ''}

                    <div class="content-grid">
                        <div class="section">
                            <h2 class="section-title">Monitored Devices</h2>
                            ${renderDevices()}
                        </div>
                        <div class="section">
                            <h2 class="section-title">Security Events</h2>
                            ${renderFilterPanel()}
                            ${renderEvents(filteredEvents)}
                        </div>
                    </div>
                </div>

                ${renderAddModal()}
                ${renderSimulateModal()}
            `;
        }

        function renderDevices() {
            if (state.devices.length === 0) {
                return `
                    <div class="empty-state">
                        ${icons.activity}
                        <p>No devices registered yet</p>
                        <button class="btn btn-primary" onclick="openAddModal()">${icons.plus} Add Your First Device</button>
                    </div>
                `;
            }

            return state.devices.map(device => `
                <div class="device-card status-${device.status}">
                    <div class="device-header">
                        <div class="device-info">
                            <h3>${device.name}</h3>
                            <p class="device-type">${device.device_type.replace('_', ' ')}</p>
                        </div>
                        <div class="device-icon">${device.status === 'online' ? icons.wifi : icons.wifiOff}</div>
                    </div>
                    <div class="device-details">
                        <div class="device-detail-row">
                            <span class="detail-label">IP Address</span>
                            <span class="detail-value">${device.ip_address}</span>
                        </div>
                        <div class="device-detail-row">
                            <span class="detail-label">MAC Address</span>
                            <span class="detail-value">${device.mac_address}</span>
                        </div>
                        <div class="device-detail-row">
                            <span class="detail-label">Status</span>
                            <span class="detail-value" style="text-transform: capitalize;">${device.status}</span>
                        </div>
                        <div class="device-detail-row">
                            <span class="detail-label">Last Seen</span>
                            <span class="detail-value">${new Date(device.last_seen).toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderFilterPanel() {
            const hasFilters = state.severityFilter !== 'all' || state.eventTypeFilter !== 'all' || state.showResolved;

            return `
                <div class="filter-panel">
                    <div class="filter-header">
                        <div class="filter-title">${icons.filter} Filters</div>
                        ${hasFilters ? `<button class="btn btn-outline" style="padding: 0.25rem 0.75rem; font-size: 0.75rem;" onclick="clearFilters()">Clear All</button>` : ''}
                    </div>
                    <div class="filter-grid">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label" style="font-size: 0.75rem;">Severity</label>
                            <select class="form-select" style="padding: 0.5rem; font-size: 0.875rem;" onchange="changeSeverityFilter(this.value)">
                                <option value="all" ${state.severityFilter === 'all' ? 'selected' : ''}>All</option>
                                <option value="critical" ${state.severityFilter === 'critical' ? 'selected' : ''}>Critical</option>
                                <option value="high" ${state.severityFilter === 'high' ? 'selected' : ''}>High</option>
                                <option value="medium" ${state.severityFilter === 'medium' ? 'selected' : ''}>Medium</option>
                                <option value="low" ${state.severityFilter === 'low' ? 'selected' : ''}>Low</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label" style="font-size: 0.75rem;">Event Type</label>
                            <select class="form-select" style="padding: 0.5rem; font-size: 0.875rem;" onchange="changeEventTypeFilter(this.value)">
                                <option value="all" ${state.eventTypeFilter === 'all' ? 'selected' : ''}>All</option>
                                <option value="brute_force" ${state.eventTypeFilter === 'brute_force' ? 'selected' : ''}>Brute Force</option>
                                <option value="ddos" ${state.eventTypeFilter === 'ddos' ? 'selected' : ''}>DDoS</option>
                                <option value="resource_anomaly" ${state.eventTypeFilter === 'resource_anomaly' ? 'selected' : ''}>Resource Anomaly</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0; display: flex; align-items: flex-end;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" ${state.showResolved ? 'checked' : ''} onchange="toggleShowResolved(this.checked)" style="width: 1rem; height: 1rem;">
                                <span style="font-size: 0.875rem; font-weight: 500;">Show Resolved</span>
                            </label>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEvents(events) {
            if (state.events.length === 0) {
                return `
                    <div class="empty-state">
                        ${icons.shield}
                        <p>No security events detected</p>
                        <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">Your devices are secure</p>
                    </div>
                `;
            }

            if (events.length === 0) {
                return `
                    <div class="empty-state">
                        ${icons.activity}
                        <p>No events match your filters</p>
                    </div>
                `;
            }

            return events.map(event => `
                <div class="event-card">
                    <div class="event-header">
                        <div class="event-badges">
                            <span class="badge badge-${event.severity}">${event.severity.toUpperCase()}</span>
                            <span class="badge" style="background: #f3f4f6; color: #374151; text-transform: capitalize;">${event.event_type.replace('_', ' ')}</span>
                        </div>
                        ${event.resolved
                            ? `<div class="resolved-badge">${icons.check} Resolved</div>`
                            : `<button class="resolve-btn" onclick="resolveEvent('${event.id}')">Resolve</button>`
                        }
                    </div>
                    ${event.devices ? `<p style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">${event.devices.name}</p>` : ''}
                    <p class="event-description">${event.description}</p>
                    <div class="event-meta">
                        ${event.source_ip && event.source_ip !== 'unknown' ? `<span>Source: ${event.source_ip}</span>` : ''}
                        <span>${new Date(event.detected_at).toLocaleString()}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderPatternsPanel() {
            return `
                <div class="patterns-panel">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                        ${icons.shield}
                        <h3 style="font-size: 1.125rem; font-weight: 600;">Attack Detection Patterns</h3>
                    </div>
                    ${state.patterns.map(pattern => `
                        <div class="pattern-item">
                            <div class="pattern-header">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <h4 class="pattern-title">${pattern.name}</h4>
                                        <span class="badge badge-${pattern.severity}">${pattern.severity}</span>
                                    </div>
                                    <p class="pattern-description">${pattern.description}</p>
                                    <div style="font-size: 0.75rem; color: #6b7280;">
                                        <span style="font-weight: 500;">Rules:</span>
                                        ${Object.entries(pattern.detection_rules).map(([key, value]) => `<span style="margin-right: 0.5rem;">${key}: ${value}</span>`).join('')}
                                    </div>
                                </div>
                                <button class="toggle-btn" onclick="togglePattern('${pattern.id}', ${pattern.active})">
                                    <div class="${pattern.active ? 'toggle-active' : 'toggle-inactive'}">
                                        ${pattern.active ? icons.toggleRight : icons.toggleLeft}
                                    </div>
                                </button>
                            </div>
                            <div class="pattern-status ${pattern.active ? 'status-active' : 'status-inactive'}">
                                ${pattern.active ? 'Active - Monitoring' : 'Inactive - Disabled'}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderAddModal() {
            return `
                <div class="modal ${state.showAddModal ? 'active' : ''}" id="addModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">Add New Device</h2>
                            <button class="close-btn" onclick="closeAddModal()">${icons.x}</button>
                        </div>
                        <form class="modal-body" onsubmit="handleAddDevice(event)">
                            <div class="form-group">
                                <label class="form-label">Device Name</label>
                                <input type="text" class="form-input" name="name" required placeholder="Living Room Camera">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Device Type</label>
                                <select class="form-select" name="device_type" required>
                                    <option value="">Select type...</option>
                                    <option value="camera">Camera</option>
                                    <option value="smart_lock">Smart Lock</option>
                                    <option value="thermostat">Thermostat</option>
                                    <option value="light_bulb">Light Bulb</option>
                                    <option value="speaker">Speaker</option>
                                    <option value="doorbell">Doorbell</option>
                                    <option value="sensor">Sensor</option>
                                    <option value="router">Router</option>
                                    <option value="hub">Hub</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">IP Address</label>
                                <input type="text" class="form-input" name="ip_address" required placeholder="192.168.1.100" pattern="^(\\d{1,3}\\.){3}\\d{1,3}$">
                            </div>
                            <div class="form-group">
                                <label class="form-label">MAC Address</label>
                                <input type="text" class="form-input" name="mac_address" required placeholder="00:1B:44:11:3A:B7" pattern="^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$">
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-outline btn-block" onclick="closeAddModal()">Cancel</button>
                                <button type="submit" class="btn btn-primary btn-block">Add Device</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderSimulateModal() {
            return `
                <div class="modal ${state.showSimulateModal ? 'active' : ''}" id="simulateModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">Simulate Attack</h2>
                            <button class="close-btn" onclick="closeSimulateModal()">${icons.x}</button>
                        </div>
                        <form class="modal-body" onsubmit="handleSimulateAttack(event)">
                            <div class="form-group">
                                <label class="form-label">Select Device</label>
                                <select class="form-select" name="device_id" required>
                                    <option value="">Choose a device...</option>
                                    ${state.devices.filter(d => d.status === 'online').map(device =>
                                        `<option value="${device.id}">${device.name} (${device.device_type})</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Attack Type</label>
                                <select class="form-select" name="attack_type" required>
                                    <option value="">Select attack type...</option>
                                    <option value="brute_force">Brute Force Attack</option>
                                    <option value="ddos">DDoS Attack</option>
                                    <option value="resource_spike">High Resource Usage</option>
                                    <option value="combined">Combined Attack</option>
                                </select>
                            </div>
                            <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem;">
                                <p style="font-size: 0.75rem; color: #92400e;">
                                    This will simulate attack metrics for the selected device and trigger detection algorithms.
                                </p>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-outline btn-block" onclick="closeSimulateModal()">Cancel</button>
                                <button type="submit" class="btn btn-danger btn-block">Simulate</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function openAddModal() {
            state.showAddModal = true;
            render();
        }

        function closeAddModal() {
            state.showAddModal = false;
            render();
        }

        function openSimulateModal() {
            state.showSimulateModal = true;
            render();
        }

        function closeSimulateModal() {
            state.showSimulateModal = false;
            render();
        }

        function handleAddDevice(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = {
                name: formData.get('name'),
                device_type: formData.get('device_type'),
                ip_address: formData.get('ip_address'),
                mac_address: formData.get('mac_address')
            };
            addDevice(data);
            closeAddModal();
        }

        function handleSimulateAttack(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const deviceId = formData.get('device_id');
            const attackType = formData.get('attack_type');

            let metrics = {
                cpu_usage: 45,
                memory_usage: 50,
                network_traffic: 1000000,
                failed_auth_attempts: 0
            };

            switch (attackType) {
                case 'brute_force':
                    metrics.failed_auth_attempts = 8;
                    break;
                case 'ddos':
                    metrics.network_traffic = 15000000;
                    break;
                case 'resource_spike':
                    metrics.cpu_usage = 95;
                    metrics.memory_usage = 93;
                    break;
                case 'combined':
                    metrics.cpu_usage = 92;
                    metrics.memory_usage = 88;
                    metrics.network_traffic = 12000000;
                    metrics.failed_auth_attempts = 6;
                    break;
            }

            simulateAttack(deviceId, metrics);
            closeSimulateModal();
        }

        function togglePatternsPanel() {
            state.showPatternsPanel = !state.showPatternsPanel;
            if (state.showPatternsPanel && state.patterns.length === 0) {
                fetchPatterns();
            }
            render();
        }

        function changeSeverityFilter(value) {
            state.severityFilter = value;
            render();
        }

        function changeEventTypeFilter(value) {
            state.eventTypeFilter = value;
            render();
        }

        function toggleShowResolved(checked) {
            state.showResolved = checked;
            render();
        }

        function clearFilters() {
            state.severityFilter = 'all';
            state.eventTypeFilter = 'all';
            state.showResolved = false;
            render();
        }

        function exportReport() {
            const filteredEvents = getFilteredEvents();
            const stats = getStats();

            const report = {
                generated_at: new Date().toISOString(),
                total_devices: stats.totalDevices,
                online_devices: stats.onlineDevices,
                compromised_devices: stats.compromisedDevices,
                total_events: filteredEvents.length,
                events: filteredEvents
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `security-report-${Date.now()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        supabase
            .channel('devices-changes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'devices' }, () => {
                fetchDevices();
            })
            .subscribe();

        supabase
            .channel('events-changes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'security_events' }, () => {
                fetchEvents();
            })
            .subscribe();

        fetchDevices();
        fetchEvents();
    </script>
</body>
</html>
